<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPP Care Control</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin-styles.css">
    <style>
    /* –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—Ä–∞–∑—É) */
    .admin-overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    
    /* === –°–¢–ò–õ–ò –ö–û–õ–ï–°–ê –ë–ê–õ–ê–ù–°–ê (–í–°–¢–†–û–ï–ù–ù–´–ï) === */
    #wheel-modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        overflow-y: auto;
    }
    .wheel-modal-content {
        background: #fff;
        margin: 50px auto;
        padding: 20px;
        width: 95%;
        max-width: 800px;
        border-radius: 15px;
        position: relative;
        font-family: 'Segoe UI', sans-serif;
    }
    .wheel-close-btn {
        position: absolute;
        top: 15px; right: 20px;
        font-size: 30px;
        cursor: pointer;
        color: #555;
        font-weight: bold;
    }
    .wheel-category {
        border: 1px solid #eee;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        background: #f9f9f9;
    }
    .wheel-category h3 { margin-top: 0; }
    .wheel-question { margin-bottom: 8px; display: block; cursor: pointer; }
    .wheel-action-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 30px;
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
        font-weight: bold;
        transition: opacity 0.2s;
    }
    .wheel-action-btn:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div id="app">
        <div id="login-screen" class="screen">
            <div class="login-container">
                <h1>üèÉ KPP Care Control</h1>
                <p class="subtitle">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
                <form id="login-form">
                    <input type="text" id="login-username" placeholder="–õ–æ–≥–∏–Ω" required autocomplete="username">
                    <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required autocomplete="current-password">
                    <button type="submit">–í–æ–π—Ç–∏</button>
                </form>
                <p class="hint">–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å - –æ–Ω–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</p>
            </div>
        </div>

        <div id="user-screen" class="screen hidden">
            <header class="app-header">
                <h2 id="user-welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                <button id="logout-btn" class="btn-secondary">–í—ã–π—Ç–∏</button>
            </header>

            <nav class="tabs">
                <button class="tab-btn active" data-tab="summary">üìä –°–≤–æ–¥–∫–∞</button>
                <button class="tab-btn" data-tab="steps">üö∂ –®–∞–≥–∏</button>
                <button class="tab-btn" data-tab="morningExercise">üßò –ó–∞—Ä—è–¥–∫–∞</button>
                <button class="tab-btn" data-tab="abs">üí™ –ü—Ä–µ—Å—Å</button>
                <button class="tab-btn" data-tab="workout">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</button>
                <button class="tab-btn" data-tab="water">üíß –í–æ–¥–∞</button>
                <button class="tab-btn" data-tab="nutrition">üçΩÔ∏è –ü–∏—Ç–∞–Ω–∏–µ</button>
                <button class="tab-btn" data-tab="sleep">üõèÔ∏è –°–æ–Ω</button>
                <button class="tab-btn" data-tab="measurements">üìè –ò–∑–º–µ—Ä–µ–Ω–∏—è</button>
            </nav>

            <main class="content">
                <section id="tab-summary" class="tab-content active">
                    <div id="today-date" style="display: none;"></div>
                    <div id="summary-blocks">
                        </div>
                    <div class="missing-days" id="missing-days-alert"></div>
                    <div class="input-section">
                        <h3>–í–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                        <form id="today-form" class="compact-form">
                            <div class="form-row">
                                <label>
                                    –í—Å–µ–≥–æ —à–∞–≥–æ–≤
                                    <input type="number" id="input-total-steps" min="0" placeholder="0">
                                </label>
                                <label>
                                    –®–∞–≥–æ–≤ –Ω–∞ –¥–æ—Ä–æ–∂–∫–µ
                                    <input type="number" id="input-treadmill-steps" min="0" placeholder="0">
                                </label>
                            </div>
                            <div class="form-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="input-morningExercise">
                                    –ó–∞—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
                                </label>                                     
                                <label class="checkbox-label">
                                    <input type="checkbox" id="input-workout">
                                    –ë—ã–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="input-abs">
                                    –ü—Ä–µ—Å—Å —Å–¥–µ–ª–∞–Ω
                                </label>
                            </div>
                            <div class="form-row">
                                <label>
                                    –ü–∏—Ç–∞–Ω–∏–µ
                                    <select id="input-nutrition">
                                        <option value="2">–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ</option>
                                        <option value="1">–ù–µ–±–æ–ª—å—à–æ–µ –ø–µ—Ä–µ–µ–¥–∞–Ω–∏–µ</option>
                                        <option value="0" selected>–ü–æ –ø–ª–∞–Ω—É</option>
                                        <option value="-1">–ù–µ–±–æ–ª—å—à–æ–µ –Ω–µ–¥–æ–µ–¥–∞–Ω–∏–µ</option>
                                        <option value="-2">–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –Ω–µ–¥–æ–µ–¥–∞–Ω–∏–µ</option>
                                    </select>
                                </label>
                                <label>
                                    –í–æ–¥–∞
                                    <select id="input-water">
                                        <option value="0">&lt;250 –º–ª</option>
                                        <option value="1">250‚Äì500 –º–ª</option>
                                        <option value="2">500‚Äì750 –º–ª</option>
                                        <option value="3" selected>750‚Äì1000 –º–ª</option>
                                        <option value="4">1‚Äì1.5 –ª</option>
                                        <option value="5">1.5‚Äì2 –ª</option>
                                        <option value="6">&gt;2 –ª</option>
                                    </select>
                                </label>
                            </div>
                            
                            <div class="form-section sleep-section" style="background-color: #f0f8ff; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #667eea;">
                                <h4 style="margin: 0 0 15px 0; color: #667eea;">üí§ –°–æ–Ω</h4>
                                <div class="form-row">
                                    <label>
                                        –í–æ —Å–∫–æ–ª—å–∫–æ –ª–µ–≥–ª–∏ –≤—á–µ—Ä–∞?
                                        <input type="time" id="input-bed-time" placeholder="23:30">
                                    </label>
                                    <label>
                                        –í–æ —Å–∫–æ–ª—å–∫–æ –≤—Å—Ç–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è?
                                        <input type="time" id="input-wake-time" placeholder="07:00">
                                    </label>
                                </div>
                                <div id="sleep-duration-display" style="text-align: center; margin-top: 10px; font-size: 1.1em; color: #667eea; font-weight: bold;">
                                    –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <span id="sleep-duration-value">‚Äî</span>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn-primary" style="margin-top: 20px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </form>
                    </div>
                </section>

                <section id="tab-steps" class="tab-content">
                    <div class="stats-header"><h3>–ò—Å—Ç–æ—Ä–∏—è —à–∞–≥–æ–≤</h3><div class="stats-summary" id="steps-stats"></div></div>
                    <div class="history-container" id="steps-history"></div>
                </section>
                
                <section id="tab-morningExercise" class="tab-content">
                    <div class="stats-header"><h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞—Ä—è–¥–∫–∏</h3><div class="stats-summary" id="morningExercise-stats"></div></div>
                    <div class="history-container" id="morningExercise-history"></div>
                </section>

                <section id="tab-abs" class="tab-content">
                    <div class="stats-header"><h3>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ—Å—Å–∞</h3><div class="stats-summary" id="abs-stats"></div></div>
                    <div class="history-container" id="abs-history"></div>
                </section>

                <section id="tab-workout" class="tab-content">
                    <div class="stats-header"><h3>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3><div class="stats-summary" id="workout-stats"></div></div>
                    <div class="history-container" id="workout-history"></div>
                </section>

                <section id="tab-water" class="tab-content">
                    <div class="stats-header"><h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤–æ–¥—ã</h3><div class="stats-summary" id="water-stats"></div></div>
                    <div class="history-container" id="water-history"></div>
                </section>

                <section id="tab-nutrition" class="tab-content">
                    <div class="stats-header"><h3>–ò—Å—Ç–æ—Ä–∏—è –ø–∏—Ç–∞–Ω–∏—è</h3><div class="stats-summary" id="nutrition-stats"></div></div>
                    <div class="history-container" id="nutrition-history"></div>
                </section>

                <section id="tab-sleep" class="tab-content">
                      <div class="stats-header"><h3>üõèÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Å–Ω–∞</h3><div class="stats-summary" id="sleep-stats"></div></div>
                      <div class="history-container">
                        <div class="history-section"><h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h4><div id="sleep-last-week" class="history-grid"></div></div>
                        <div class="history-section"><h4>–ü–æ –Ω–µ–¥–µ–ª—è–º</h4><div id="sleep-by-weeks"></div></div>
                      </div>
                </section>
             
                <section id="tab-measurements" class="tab-content">
                    <div id="measurements-form"></div>
                    <div id="measurements-history"></div>
                </section>
            </main>
        </div>
                    
        <div id="admin-screen" class="screen hidden">
            <header class="app-header">
                <h2>üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                <button id="admin-logout-btn" class="btn-secondary">–í—ã–π—Ç–∏</button>
            </header>
            <nav class="tabs">
                <button class="admin-tab-btn active" data-admin-tab="overview">üìä –û–±–∑–æ—Ä</button>
                <button class="admin-tab-btn" data-admin-tab="detailed">üìà –î–µ—Ç–∞–ª—å–Ω–æ</button>
            </nav>
            <main class="content">
                <div id="admin-tab-overview" class="admin-tab-content active">
                    <div id="users-list" class="users-grid"></div>
                </div>
                <div id="admin-tab-detailed" class="admin-tab-content">
                    <div id="admin-detailed-content"></div>
                </div>
            </main>
        </div>
    </div>
    
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 100;">
        <button onclick="toggleWheelModal(true)" 
                style="padding: 15px 25px; 
                       background: #6c5ce7; 
                       color: white; 
                       border: none; 
                       border-radius: 50px; 
                       box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
                       font-weight: bold; 
                       cursor: pointer;
                       font-size: 16px;">
            üéØ –û—Ç–∫—Ä—ã—Ç—å –ö–æ–ª–µ—Å–æ
        </button>
    </div>

    <div id="wheel-modal-overlay">
        <div class="wheel-modal-content">
            <span class="wheel-close-btn" onclick="toggleWheelModal(false)">&times;</span>
            <h2 style="text-align:center">üéØ –ö–æ–ª–µ—Å–æ –±–∞–ª–∞–Ω—Å–∞ –ø–∏—Ç–∞–Ω–∏—è</h2>
            <p style="text-align:center; color:#666;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —á–µ–∫–ª–∏—Å—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>

            <form id="wheel-form">
                <div class="wheel-category" style="border-left: 5px solid #3498db;">
                    <h3>üíß –í–æ–¥–∞</h3>
                    <label class="wheel-question"><input type="checkbox" name="water"> –Ø –æ—Ç–ª–∏—á–∞—é –∂–∞–∂–¥—É –æ—Ç –≥–æ–ª–æ–¥–∞</label>
                    <label class="wheel-question"><input type="checkbox" name="water"> –Ø –Ω–∞—á–∏–Ω–∞—é —É—Ç—Ä–æ —Å –≤–æ–¥—ã</label>
                    <label class="wheel-question"><input type="checkbox" name="water"> –¢–µ—Å—Ç–æ–≤—ã–π –≥–ª–æ—Ç–æ–∫</label>
                </div>
                <div class="wheel-category" style="border-left: 5px solid #e74c3c;">
                    <h3>ü•© –ë–µ–ª–æ–∫</h3>
                    <label class="wheel-question"><input type="checkbox" name="protein"> –ï–º –±–µ–ª–æ–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</label>
                </div>
                <div class="wheel-category" style="border-left: 5px solid #f39c12;">
                    <h3>ü•ë –ñ–∏—Ä—ã</h3>
                    <label class="wheel-question"><input type="checkbox" name="fats"> –ï–º –ø–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã</label>
                </div>
                </form>

            <button class="wheel-action-btn" onclick="calculateAndSaveWheel()">
                üíæ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>

            <div id="wheel-result-area" style="display:none; margin-top:20px; text-align:center;">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω! ‚úÖ</h3>
                <p>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–∞–∑—É.</p>
                <canvas id="wheel-canvas-mini" width="300" height="300" style="max-width:100%"></canvas>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="config.js"></script>
    <script src="firebase-init.js"></script>
    
    <script src="auth.js"></script>
    <script src="data-logic.js"></script>
    <script src="measurements-logic.js"></script>
    <script src="sleep-logic.js"></script>
    <script src="admin-logic.js"></script>
    <script src="admin-ui.js"></script>
    <script src="ui.js"></script>
    <script src="sleep-ui.js"></script>
    <script src="app.js"></script>
    
    <script>
    // --- –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ö–æ–ª–µ—Å–∞ ---
    function toggleWheelModal(show) {
        document.getElementById('wheel-modal-overlay').style.display = show ? 'block' : 'none';
        if (!show) {
            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            document.getElementById('wheel-result-area').style.display = 'none';
        }
    }

    function calculateAndSaveWheel() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const user = firebase.auth().currentUser;
        if (!user) {
            alert("‚ö†Ô∏è –û—à–∏–±–∫–∞: –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
            return;
        }

        const form = document.getElementById('wheel-form');
        const count = (name) => form.querySelectorAll(`input[name="${name}"]:checked`).length;

        const scores = {
            water: count('water'),
            protein: count('protein'),
            fats: count('fats'),
            carbs: count('carbs'),
            fiber: count('fiber'),
            variety: count('variety'),
            organization: count('organization')
        };

        // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const btn = document.querySelector('.wheel-action-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        btn.disabled = true;

        firebase.firestore()
            .collection("users")
            .doc(user.uid)
            .collection("nutritionWheel")
            .add({
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                scores: scores
            })
            .then(() => {
                document.getElementById('wheel-result-area').style.display = 'block';
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert("üéâ –£—Ä–∞! –ö–æ–ª–µ—Å–æ –±–∞–ª–∞–Ω—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å!");
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
                drawMiniWheel(scores);
            })
            .catch((error) => {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–ª–µ—Å–∞:", error);
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    function drawMiniWheel(scores) {
        const canvas = document.getElementById('wheel-canvas-mini');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const maxRadius = 140;
        
        // –¶–≤–µ—Ç–∞ (—Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏)
        const colors = ['#3498db', '#e74c3c', '#f39c12', '#2ecc71', '#9b59b6', '#1abc9c', '#e67e22'];
        const values = Object.values(scores); // –ú–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < 7; i++) {
            const val = values[i] || 0;
            const radius = (maxRadius / 10) * val;
            const startAngle = (Math.PI * 2 * i) / 7 - Math.PI / 2;
            const endAngle = (Math.PI * 2 * (i + 1)) / 7 - Math.PI / 2;
            
            ctx.fillStyle = colors[i];
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.fill();
            
            // –ö–æ–Ω—Ç—É—Ä —Å–µ–∫—Ç–æ—Ä–∞ (—Å–µ—Ç–∫–∞)
            ctx.strokeStyle = '#eee';
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, maxRadius, startAngle, endAngle);
            ctx.stroke();
        }
    }
    </script>
</body>
</html>
